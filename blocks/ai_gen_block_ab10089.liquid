{% doc %}
  @prompt
    I want to have a selected collection field.
    Then from that attribute I want a section that can act like a header with a selectable logo, and a currency selector. I want the logo to be selectable by upload, or tied to a metafield per template., I want to be able to select the logo position and I woulld like the currency selector to be just like in the header and have the same account and cart links like i have on the dawn header, can you preselect the customers local currency based on location and the use the same styling as the header on our Dawn home page? , Can you also have the country name beside the Currency like United States | USD$ Also make the shopping bag icon the same size as the accounts icon. Finally, for the uploaded logo, I would like to choose where it links to instead of it taking me to the home page.
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-custom-header-{{ ai_gen_id }} {
    display: block;
    width: 100%;
    background-color: {{ block.settings.background_color }};
    border-bottom: 1px solid {{ block.settings.border_color }};
    position: relative;
    z-index: 3;
  }

  .ai-custom-header__inner-{{ ai_gen_id }} {
    max-width: {{ settings.page_width }}px;
    margin: 0 auto;
    padding: {{ block.settings.vertical_padding }}px {{ block.settings.horizontal_padding }}px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .ai-custom-header__logo-wrapper-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    {% if block.settings.logo_position == 'left' %}
      order: 1;
    {% elsif block.settings.logo_position == 'center' %}
      order: 2;
      flex: 1;
      justify-content: center;
    {% else %}
      order: 3;
    {% endif %}
  }

  .ai-custom-header__logo-link-{{ ai_gen_id }} {
    display: block;
    line-height: 0;
  }

  .ai-custom-header__logo-{{ ai_gen_id }} {
    max-width: {{ block.settings.logo_width }}px;
    height: auto;
    display: block;
  }

  .ai-custom-header__logo-placeholder-{{ ai_gen_id }} {
    width: {{ block.settings.logo_width }}px;
    height: 60px;
    background-color: #f4f4f4;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }

  .ai-custom-header__logo-placeholder-{{ ai_gen_id }} svg {
    width: 100%;
    height: 100%;
    max-width: 100px;
    max-height: 50px;
  }

  .ai-custom-header__actions-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    gap: 16px;
    {% if block.settings.logo_position == 'left' %}
      order: 3;
    {% elsif block.settings.logo_position == 'center' %}
      order: 3;
    {% else %}
      order: 1;
    {% endif %}
  }

  .ai-custom-header__localization-{{ ai_gen_id }} {
    position: relative;
  }

  .ai-custom-header__localization-button-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: {{ block.settings.text_color }};
    font-size: 14px;
    border-radius: {{ settings.buttons_radius }}px;
    transition: background-color 0.2s ease;
  }

  .ai-custom-header__localization-button-{{ ai_gen_id }}:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .ai-custom-header__localization-icon-{{ ai_gen_id }} {
    width: 12px;
    height: 12px;
    transition: transform 0.2s ease;
  }

  .ai-custom-header__localization-button-{{ ai_gen_id }}[aria-expanded="true"] .ai-custom-header__localization-icon-{{ ai_gen_id }} {
    transform: rotate(180deg);
  }

  .ai-custom-header__localization-dropdown-{{ ai_gen_id }} {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background-color: #ffffff;
    border: {{ settings.popup_border_thickness }}px solid rgba(0, 0, 0, {{ settings.popup_border_opacity | divided_by: 100.0 }});
    border-radius: {{ settings.popup_corner_radius }}px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    min-width: 200px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
    z-index: 10;
  }

  .ai-custom-header__localization-dropdown-{{ ai_gen_id }}.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .ai-custom-header__localization-form-{{ ai_gen_id }} {
    padding: 8px;
  }

  .ai-custom-header__localization-option-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    font-size: 14px;
    color: #121212;
  }

  .ai-custom-header__localization-option-{{ ai_gen_id }}:hover {
    background-color: #f3f3f3;
  }

  .ai-custom-header__localization-option-{{ ai_gen_id }}.selected {
    background-color: #f3f3f3;
    font-weight: 600;
  }

  .ai-custom-header__localization-radio-{{ ai_gen_id }} {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .ai-custom-header__icon-link-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    color: {{ block.settings.text_color }};
    text-decoration: none;
    padding: 8px;
    border-radius: {{ settings.buttons_radius }}px;
    transition: background-color 0.2s ease;
    position: relative;
  }

  .ai-custom-header__icon-link-{{ ai_gen_id }}:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .ai-custom-header__icon-{{ ai_gen_id }} {
    width: 20px;
    height: 20px;
  }

  .ai-custom-header__cart-count-{{ ai_gen_id }} {
    position: absolute;
    top: 2px;
    right: 2px;
    background-color: {{ block.settings.badge_color }};
    color: {{ block.settings.badge_text_color }};
    font-size: 11px;
    font-weight: 600;
    min-width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
  }

  @media screen and (max-width: 749px) {
    .ai-custom-header__inner-{{ ai_gen_id }} {
      padding: {{ block.settings.vertical_padding | times: 0.8 }}px {{ block.settings.horizontal_padding | times: 0.8 }}px;
    }

    .ai-custom-header__logo-{{ ai_gen_id }} {
      max-width: {{ block.settings.logo_width | times: 0.7 }}px;
    }

    .ai-custom-header__actions-{{ ai_gen_id }} {
      gap: 12px;
    }

    .ai-custom-header__localization-button-{{ ai_gen_id }} {
      padding: 6px 8px;
      font-size: 13px;
    }
  }
{% endstyle %}

<custom-header-{{ ai_gen_id }} class="ai-custom-header-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
  <div class="ai-custom-header__inner-{{ ai_gen_id }}">
    <div class="ai-custom-header__logo-wrapper-{{ ai_gen_id }}">
      {% liquid
        assign logo_image = null
        assign logo_url = block.settings.logo_link

        if logo_url == blank
          assign logo_url = routes.root_url
        endif

        if block.settings.logo_source == 'upload' and block.settings.logo_upload != blank
          assign logo_image = block.settings.logo_upload
        elsif block.settings.logo_source == 'metafield' and block.settings.collection != blank and block.settings.collection.metafields[block.settings.metafield_namespace][block.settings.metafield_key] != blank
          assign logo_image = block.settings.collection.metafields[block.settings.metafield_namespace][block.settings.metafield_key]
        endif
      %}

      <a href="{{ logo_url }}" class="ai-custom-header__logo-link-{{ ai_gen_id }}">
        {% if logo_image != blank %}
          <img
            src="{{ logo_image | image_url: width: 600 }}"
            alt="{{ shop.name }}"
            class="ai-custom-header__logo-{{ ai_gen_id }}"
            width="{{ logo_image.width }}"
            height="{{ logo_image.height }}"
            loading="lazy"
          >
        {% else %}
          <div class="ai-custom-header__logo-placeholder-{{ ai_gen_id }}">
            {{ 'image' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </a>
    </div>

    <div class="ai-custom-header__actions-{{ ai_gen_id }}">
      {% if block.settings.show_currency_selector %}
        <div class="ai-custom-header__localization-{{ ai_gen_id }}">
          <button
            type="button"
            class="ai-custom-header__localization-button-{{ ai_gen_id }}"
            aria-expanded="false"
            aria-controls="ai-custom-header-localization-dropdown-{{ ai_gen_id }}"
          >
            <span class="ai-custom-header__localization-text-{{ ai_gen_id }}">
              {{ localization.country.name }} | {{ localization.country.currency.iso_code }}{{ localization.country.currency.symbol }}
            </span>
            <svg class="ai-custom-header__localization-icon-{{ ai_gen_id }}" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <div
            id="ai-custom-header-localization-dropdown-{{ ai_gen_id }}"
            class="ai-custom-header__localization-dropdown-{{ ai_gen_id }}"
          >
            {%- form 'localization', class: 'ai-custom-header__localization-form-' | append: ai_gen_id -%}
              <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
              
              {% for country in localization.available_countries %}
                <label class="ai-custom-header__localization-option-{{ ai_gen_id }} {% if country.iso_code == localization.country.iso_code %}selected{% endif %}">
                  <input
                    type="radio"
                    name="country_code"
                    value="{{ country.iso_code }}"
                    class="ai-custom-header__localization-radio-{{ ai_gen_id }}"
                    {% if country.iso_code == localization.country.iso_code %}checked{% endif %}
                  >
                  <span>{{ country.name }} | {{ country.currency.iso_code }}{{ country.currency.symbol }}</span>
                </label>
              {% endfor %}
            {%- endform -%}
          </div>
        </div>
      {% endif %}

      {% if block.settings.show_account_link %}
        <a href="{{ routes.account_url }}" class="ai-custom-header__icon-link-{{ ai_gen_id }}" aria-label="Account">
          <svg class="ai-custom-header__icon-{{ ai_gen_id }}" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 10C12.7614 10 15 7.76142 15 5C15 2.23858 12.7614 0 10 0C7.23858 0 5 2.23858 5 5C5 7.76142 7.23858 10 10 10Z" fill="currentColor"/>
            <path d="M10 12C4.47715 12 0 14.4772 0 17.5V20H20V17.5C20 14.4772 15.5228 12 10 12Z" fill="currentColor"/>
          </svg>
        </a>
      {% endif %}

      {% if block.settings.show_cart_link %}
        <a href="{{ routes.cart_url }}" class="ai-custom-header__icon-link-{{ ai_gen_id }}" aria-label="Cart">
          <svg class="ai-custom-header__icon-{{ ai_gen_id }}" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M0 2C0 1.44772 0.447715 1 1 1H3C3.47363 1 3.88593 1.33689 3.97553 1.80344L4.61096 5H18C18.3466 5 18.6684 5.17945 18.8507 5.47427C19.0329 5.76909 19.0494 6.13723 18.8944 6.44721L15.8944 12.4472C15.725 12.786 15.3788 13 15 13H7C6.52637 13 6.11407 12.6631 6.02447 12.1966L4.08553 3H1C0.447715 3 0 2.55228 0 2ZM5.03096 7L6.47553 13H14.382L16.882 7H5.03096Z" fill="currentColor"/>
            <path d="M8 18C8 19.1046 7.10457 20 6 20C4.89543 20 4 19.1046 4 18C4 16.8954 4.89543 16 6 16C7.10457 16 8 16.8954 8 18Z" fill="currentColor"/>
            <path d="M16 18C16 19.1046 15.1046 20 14 20C12.8954 20 12 19.1046 12 18C12 16.8954 12.8954 16 14 16C15.1046 16 16 16.8954 16 18Z" fill="currentColor"/>
          </svg>
          {% if cart.item_count > 0 %}
            <span class="ai-custom-header__cart-count-{{ ai_gen_id }}">{{ cart.item_count }}</span>
          {% endif %}
        </a>
      {% endif %}
    </div>
  </div>
</custom-header-{{ ai_gen_id }}>

<script>
  (function() {
    class CustomHeader{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.localizationButton = this.querySelector('.ai-custom-header__localization-button-{{ ai_gen_id }}');
        this.localizationDropdown = this.querySelector('.ai-custom-header__localization-dropdown-{{ ai_gen_id }}');
        this.localizationForm = this.querySelector('.ai-custom-header__localization-form-{{ ai_gen_id }}');
      }

      connectedCallback() {
        if (this.localizationButton && this.localizationDropdown) {
          this.setupLocalization();
        }
      }

      setupLocalization() {
        this.localizationButton.addEventListener('click', () => {
          const isExpanded = this.localizationButton.getAttribute('aria-expanded') === 'true';
          this.localizationButton.setAttribute('aria-expanded', !isExpanded);
          this.localizationDropdown.classList.toggle('active');
        });

        document.addEventListener('click', (event) => {
          if (!this.contains(event.target)) {
            this.localizationButton.setAttribute('aria-expanded', 'false');
            this.localizationDropdown.classList.remove('active');
          }
        });

        const radioInputs = this.localizationForm.querySelectorAll('input[type="radio"]');
        radioInputs.forEach((radio) => {
          radio.addEventListener('change', () => {
            this.localizationForm.submit();
          });
        });
      }
    }

    customElements.define('custom-header-{{ ai_gen_id }}', CustomHeader{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Custom collection header",
  "settings": [
    {
      "type": "header",
      "content": "Collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "select",
      "id": "logo_source",
      "label": "Logo source",
      "options": [
        {
          "value": "upload",
          "label": "Upload"
        },
        {
          "value": "metafield",
          "label": "Collection metafield"
        }
      ],
      "default": "upload"
    },
    {
      "type": "image_picker",
      "id": "logo_upload",
      "label": "Upload logo"
    },
    {
      "type": "text",
      "id": "metafield_namespace",
      "label": "Metafield namespace",
      "default": "custom"
    },
    {
      "type": "text",
      "id": "metafield_key",
      "label": "Metafield key",
      "default": "logo"
    },
    {
      "type": "url",
      "id": "logo_link",
      "label": "Logo link"
    },
    {
      "type": "range",
      "id": "logo_width",
      "label": "Logo width",
      "min": 50,
      "max": 300,
      "step": 10,
      "unit": "px",
      "default": 150
    },
    {
      "type": "select",
      "id": "logo_position",
      "label": "Logo position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Header actions"
    },
    {
      "type": "checkbox",
      "id": "show_currency_selector",
      "label": "Show currency selector",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account_link",
      "label": "Show account link",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cart_link",
      "label": "Show cart link",
      "default": true
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e8e8e8"
    },
    {
      "type": "color",
      "id": "badge_color",
      "label": "Cart badge color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Cart badge text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "vertical_padding",
      "label": "Vertical padding",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "horizontal_padding",
      "label": "Horizontal padding",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    }
  ],
  "presets": [
    {
      "name": "Custom collection header"
    }
  ]
}
{% endschema %}
